---
title: "Dashboard"
author: "DecoderMaverick"
format:
  dashboard:
    orientation: rows
    theme: default
server: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, warning = FALSE, message = FALSE)
```

```{r include=FALSE, echo = FALSE}
#| label: libraries
#| context: setup
library(tidyverse)
library(ggplot2)
library(dplyr)
library(stringr)
library(lubridate)
library(cobalt)
library(compareGroups)
```

```{r include=FALSE, echo = FALSE}
#| label: data loading
#| context: setup
data_raw <- read.csv('unsw_datathon_2025.csv')
```

# Home {scrolling="true"}

## Introduction

<h1><span style="color:#423A8E">Welcome to the Australian Hip Fracture Registry</span></h1>

This dashboard is a tool to benchmark hospital performance against the ACSQHC clinical quality indicators. <br>

Each page represents one clinical care standard requirement and shows indicators that will support hospitals to monitor how well they are implementing the care recommended in these requirements and are intended to support local quality improvement activities.<br>

## Hospital Snapshot

### 

```{r include=FALSE, echo = FALSE}
alive_not_discharged <- data_raw %>%
  filter(mort365d  != 2 & (tarrdatetime_year>2023 | arrdatetime_year>2023 |admdatetimeop_year>2023) & is.na(hdisch_year))

patients_2024 <- data_raw %>%
  filter(tarrdatetime_year==2024 | arrdatetime_year==2024 |admdatetimeop_year==2024)
```


<h2><span style="color:#423A8E">Hospital Snapshot</span></h2>


<div class="kpi-cards">
  <div class="kpi-card" style="background-color:#FFC107;">
   Active Patients <br>`r nrow(alive_not_discharged)`
  </div>

  <div class="kpi-card" style="background-color:#DC3545;">
   Last Modified <br>`r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` <br>`r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`
  </div>

  <div class="kpi-card" style="background-color:#198754;">
   2024 Records <br>`r nrow(patients_2024)`
  </div>

  <div class="kpi-card" style="background-color:#0D6EFD;">
   All Records <br>`r nrow(data_raw)`
  </div>
</div>


<style>

.kpi-cards {
  display: grid;
  grid-template-columns: repeat(4, minmax(200px, 1fr)); /* 4 columns */
  gap: 0.75rem;
  margin: 1rem 0;
}

.kpi-card {
  min-height: 80px;
  border-radius: 1rem;
  padding: 0.75rem 1rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.98rem;
  color: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);

  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

/* Responsive: 2 columns on tablets, stack on phones */
@media (max-width: 992px) {
  .kpi-cards { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
}
@media (max-width: 576px) {
  .kpi-cards { grid-template-columns: 1fr; }
}

</style>


##

### Hip Fracture Clinical Care Standard


<h2><span style="color:#423A8E">Hip Fracture Clinical Care Standard</span></h2>

<h3><span>Click the button to get to the next page</span></h3>

<!-- Row 1: 4 tiles -->
<div class="page-button">
  <div class="page-button__item">[Care at presentation](#qs-1)</div>
  <div class="page-button__item">[Pain management](#qs-2)</div>
  <div class="page-button__item">[Orthogeriatric model of care](#qs-3)</div>
  <div class="page-button__item">[Timing of surgery](#qs-4)</div>
</div>


<!-- Row 2: 3 tiles -->
<div class="page-button" style="grid-template-columns: repeat(3, minmax(220px, 1fr));">
  <div class="page-button__item">[Mobilisation and weight bearing](#qs-5)</div>
  <div class="page-button__item">[Minimising risk of another fracture](#qs-6)</div>
  <div class="page-button__item">[Transition from hospital care](#qs-7)</div>
</div>



<style>
/* Container: 4 columns on desktop */
.page-button {
  display: grid;
  grid-template-columns: repeat(4, minmax(200px, 1fr));
  gap: 0.75rem;
  margin: 1rem 0;
}

/* Tile style */
.page-button__item {
  min-height: 80px;
  border-radius: 1rem;
  padding: 0.75rem 1rem;
  text-align: center;
  font-weight: 600;
  font-size: 0.98rem;
  color: #ffff;
  background: #423A8E;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);

  display: flex;
  align-items: center;
  justify-content: center;
}

/* Make the whole tile clickable */
.page-button__item a {
  color: #fff;
  text-decoration: none;
  width: 100%;
}

/* Hover/focus states */
.page-button__item:hover,
.page-button__item:focus-within {
  background: #423A8E;
}

/* Responsive: 2 columns on tablets, stack on phones */
@media (max-width: 992px) {
  .page-button { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
}
@media (max-width: 576px) {
  .page-button { grid-template-columns: 1fr; }
}
</style>


# QS 1 {#qs-1 scrolling="true"}

<h1><span style="color:#423A8E">Care at presentation</span></h1>

A person presenting to hospital with a suspected hip fracture receives care that is guided by timely assessment and management of medical conditions, including cognition.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

##

<h2><span style="color:#423A8E">Indicator 1a</span></h2>

Proportion of patients with a hip fracture who were screened for cognitive impairment using a validated tool on presentation to hospital.

##

<h3><span style="color:#423A8E">National Data</span></h3>

```{r, echo=FALSE}
#| context: server

patients_per_hosp_cogassess <- data_raw %>%
  filter(cogassess %in% c(2, 3)) %>%   # keep only 2 or 3
  group_by(ahos_code) %>%
  summarise(n_patients = n(), .groups = "drop") %>%
  arrange(desc(n_patients))

totals <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(total_patients = n(), .groups = "drop")

result_cogassess <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(
    total_patients = n(),
    n_23 = sum(cogassess %in% c(2, 3), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(pct_2_or_3 = round(100 * n_23 / total_patients, 1))

national_prop_cogassess <- data_raw %>%
  summarise(
    n_total = n(),
    n_23    = sum(cogassess %in% c(2, 3), na.rm = TRUE),
    prop_23 = round(100 * n_23 / n_total, 1)
  )
```


```{r, echo=FALSE}
#| context: server
output$indicator1a_plot <- renderPlot({
  req(result_cogassess, national_prop_cogassess)

  ggplot(result_cogassess,
       aes(x = reorder(ahos_code, pct_2_or_3), y = pct_2_or_3)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = national_prop_cogassess$prop_23,
             color = "red", linetype = "dashed", size = 1) +
  geom_label(
    data = national_prop_cogassess,
    aes(x = max(as.numeric(factor(result_cogassess$ahos_code))) * 0.9,
        y = prop_23,
        label = "National Proportion"),
    inherit.aes = FALSE,
    color = "red", size = 3
  ) +
  labs(title = "Proportion of Patients Screened for Cognitive Impairment on Presentation",
       x = "Operating Hospital", y = "Patients screened (%)") +
  theme_minimal() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())
})
```

```{r, echo=FALSE}
#| context: render
#| panel: fill
plotOutput("indicator1a_plot")
```

##

[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}

# QS 2 {#qs-2 scrolling="true"}

<h1><span style="color:#423A8E">Pain management</span></h1>

A person with a hip fracture is assessed for pain at the time of presentation to the emergency department and regularly throughout their acute admission. Pain management includes appropriate multimodal analgesia and nerve blocks, unless contraindicated.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

## 

<h2><span style="color:#423A8E">Indicator 2a</span></h2>

Proportion of patients with a hip fracture who either received analgesia within 30 minutes of presentation or did not require it according to an assessment of their pain.

##

<h2><span style="color:#423A8E">Indicator 2b</span></h2>

Proportion of patients with a hip fracture who received a nerve block prior to surgery.

##

<h3><span style="color:#423A8E">National Data</span></h3>

```{r, echo=FALSE}
#| context: server

patients_per_hosp_analges <- data_raw %>%
  filter(analges %in% c(1, 2, 3)) %>% 
  group_by(ahos_code) %>%
  summarise(n_patients = n(), .groups = "drop") %>%
  arrange(desc(n_patients))

totals <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(total_patients = n(), .groups = "drop")

result_analges <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(
    total_patients = n(),
    n_123 = sum(analges %in% c(1, 2, 3), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(pct_123 = round(100 * n_123 / total_patients, 1))

national_prop_analges <- data_raw %>%
  summarise(
    n_total = n(),
    n_123    = sum(analges %in% c(1, 2, 3), na.rm = TRUE),
    prop_123 = round(100 * n_123 / n_total, 1)
  )
```


```{r, echo=FALSE}
#| context: server
output$indicator2b_plot <- renderPlot({
  req(result_analges, national_prop_analges)

  ggplot(result_analges,
       aes(x = reorder(ahos_code, pct_123), y = pct_123)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = national_prop_analges$prop_123,
             color = "red", linetype = "dashed", size = 1) +
  geom_label(
    data = national_prop_analges,
    aes(x = max(as.numeric(factor(result_analges$ahos_code))) * 0.9,
        y = prop_123,
        label = "National Proportion"),
    inherit.aes = FALSE,
    color = "red", size = 3
  ) +
  labs(title = "Proportion of patients who received a nerve block prior to surgery",
       x = "Operating Hospital", y = "Patients screened (%)") +
  theme_minimal() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())
})
```

```{r, echo=FALSE}
#| context: render
#| panel: fill
plotOutput("indicator2b_plot")
```

##

<h2><span style="color:#423A8E">Indicator 2c</span></h2>

Proportion of patients with a hip fracture who were transferred from another hospital for treatment who received a nerve block prior to transfer.

##

<h3><span style="color:#423A8E">National Data</span></h3>

```{r, echo=FALSE}
#| context: server

transferred <- data_raw %>% filter(e_dadmit %in% c(2,4))

patients_per_hosp_tfanalges <- transferred  %>%
  filter(tfanalges %in% c(2)) %>% 
  group_by(ahos_code) %>%
  summarise(n_patients = n(), .groups = "drop") %>%
  arrange(desc(n_patients))

total_trans <- transferred %>%
  group_by(ahos_code) %>%
  summarise(total_patients = n(), .groups = "drop")

result_tfanalges <- transferred  %>%
  group_by(ahos_code) %>%
  summarise(
    total_patients = n(),
    n_2 = sum(tfanalges %in% c(2), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(pct_2 = round(100 * n_2 / total_patients, 1))

national_prop_tfanalges <- transferred %>%
  summarise(
    n_total = n(),
    n_2    = sum(tfanalges %in% c(2), na.rm = TRUE),
    prop_2 = round(100 * n_2 / n_total, 1)
  )
```


```{r, echo=FALSE}
#| context: server
output$indicator2c_plot <- renderPlot({
  req(result_tfanalges, national_prop_tfanalges)

  ggplot(result_tfanalges,
       aes(x = reorder(ahos_code, pct_2), y = pct_2)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = national_prop_tfanalges$prop_2,
             color = "red", linetype = "dashed", size = 1) +
  geom_label(
    data = national_prop_tfanalges,
    aes(x = max(as.numeric(factor(result_tfanalges$ahos_code))) * 0.9,
        y = prop_2,
        label = "National Proportion"),
    inherit.aes = FALSE,
    color = "red", size = 3
  ) +
  labs(title = "Proportion of patients transferred from another hospital who received a nerve block prior to transfer",
       x = "Operating Hospital", y = "Patients screened (%)") +
  theme_minimal() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())
})
```

```{r, echo=FALSE}
#| context: render
#| panel: fill
plotOutput("indicator2c_plot")
```


[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}

# QS 3 {#qs-3 scrolling="true"}

<h1><span style="color:#423A8E">Orthogeriatric model of care</span></h1>

A person with a hip fracture is offered treatment based on an orthogeriatric model of care as defined in the Australian and New Zealand Guideline for Hip Fracture Care. A coordinated multidisciplinary approach is used to identify and manage malnutrition, frailty, cognitive impairment and delirium.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

## 

<h2><span style="color:#423A8E">Indicator 3a</span></h2>

Proportion of patients with a hip fracture who had a clinical frailty assessment using a validated tool.

##

<h3><span style="color:#423A8E">National Data</span></h3>

```{r, echo=FALSE}
#| context: server

patients_per_hosp_frailty <- data_raw %>%
  filter(frailty %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)) %>% 
  group_by(ahos_code) %>%
  summarise(n_patients = n(), .groups = "drop") %>%
  arrange(desc(n_patients))

totals <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(total_patients = n(), .groups = "drop")

# Per-hospital frailty documentation
result_frailty <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(
    total_patients = n(),
    n_all = sum(frailty %in% 1:10, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(pct_all = round(100 * n_all / total_patients, 1))

# National frailty documentation proportion
national_prop_frailty <- data_raw %>%
  summarise(
    n_total = n(),
    n_all  = sum(frailty %in% 1:10, na.rm = TRUE),
    prop_all = round(100 * n_all / n_total, 1)
  )
```


```{r, echo=FALSE}
#| context: server
output$indicator3a_plot <- renderPlot({
  req(result_frailty, national_prop_frailty)

  ggplot(result_frailty,
         aes(x = reorder(ahos_code, pct_all), y = pct_all)) +
    geom_col(fill = "steelblue") +
    geom_hline(yintercept = national_prop_frailty$prop_all,
               color = "red", linetype = "dashed", size = 1) +
    geom_label(
      data = national_prop_frailty,
      aes(
        x = max(as.numeric(factor(result_frailty$ahos_code))) * 0.9,
        y = prop_all,
        label = "National Proportion"
      ),
      inherit.aes = FALSE,
      color = "red", size = 3
    ) +
    labs(
      title = "Proportion of patients with a recorded frailty score",
      x = "Operating Hospital",
      y = "Patients with frailty recorded (%)"
    ) +
    theme_minimal() +
    theme(
      axis.text.x  = element_blank(),
      axis.ticks.x = element_blank()
    )
})
```

```{r, echo=FALSE}
#| context: render
#| panel: fill
plotOutput("indicator3a_plot")
```


##

<h2><span style="color:#423A8E">Indicator 3b</span></h2>

Proportion of admitted patients with a hip fracture who were assessed for delirium after surgery.

##

<h3><span style="color:#423A8E">National Data</span></h3>

```{r, echo=FALSE}
#| context: server

patients_per_hosp_delassess <- data_raw %>%
  filter(delassess %in% c(2, 3)) %>%   # keep only 2 or 3
  group_by(ahos_code) %>%
  summarise(n_patients = n(), .groups = "drop") %>%
  arrange(desc(n_patients))

totals <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(total_patients = n(), .groups = "drop")

result_delassess <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(
    total_patients = n(),
    n_23 = sum(delassess %in% c(2, 3), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(pct_2_or_3 = round(100 * n_23 / total_patients, 1))

national_prop_delassess <- data_raw %>%
  summarise(
    n_total = n(),
    n_23    = sum(cogassess %in% c(2, 3), na.rm = TRUE),
    prop_23 = round(100 * n_23 / n_total, 1)
  )
```


```{r, echo=FALSE}
#| context: server
output$indicator3b_plot <- renderPlot({
  req(result_delassess, national_prop_delassess)

  ggplot(result_delassess,
       aes(x = reorder(ahos_code, pct_2_or_3), y = pct_2_or_3)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = national_prop_delassess$prop_23,
             color = "red", linetype = "dashed", size = 1) +
  geom_label(
    data = national_prop_delassess,
    aes(x = max(as.numeric(factor(result_delassess$ahos_code))) * 0.9,
        y = prop_23,
        label = "National Proportion"),
    inherit.aes = FALSE,
    color = "red", size = 3
  ) +
  labs(title = "Proportion of patients who were assessed for delirium after surgery",
       x = "Operating Hospital", y = "Patients screened (%)") +
  theme_minimal() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())
})
```

```{r, echo=FALSE}
#| context: render
#| panel: fill
plotOutput("indicator3b_plot")
```

##

<h2><span style="color:#423A8E">Indicator 3c</span></h2>

Proportion of admitted patients with a hip fracture who received protein and energy oral nutritional supplements during their admission.

##

<h3><span style="color:#423A8E">National Data</span></h3>

```{r, echo=FALSE}
#| context: server

patients_per_hosp_ons <- data_raw  %>%
  filter(ons %in% c(2)) %>% 
  group_by(ahos_code) %>%
  summarise(n_patients = n(), .groups = "drop") %>%
  arrange(desc(n_patients))

total <- data_raw %>%
  group_by(ahos_code) %>%
  summarise(total_patients = n(), .groups = "drop")

result_ons <- data_raw  %>%
  group_by(ahos_code) %>%
  summarise(
    total_patients = n(),
    n_2 = sum(ons %in% c(2), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(pct_2 = round(100 * n_2 / total_patients, 1))

national_prop_ons <- data_raw %>%
  summarise(
    n_total = n(),
    n_2    = sum(ons %in% c(2), na.rm = TRUE),
    prop_2 = round(100 * n_2 / n_total, 1)
  )
```


```{r, echo=FALSE}
#| context: server
output$indicator3c_plot <- renderPlot({
  req(result_ons, national_prop_ons)

  ggplot(result_ons,
       aes(x = reorder(ahos_code, pct_2), y = pct_2)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = national_prop_ons$prop_2,
             color = "red", linetype = "dashed", size = 1) +
  geom_label(
    data = national_prop_ons,
    aes(x = max(as.numeric(factor(result_ons$ahos_code))) * 0.9,
        y = prop_2,
        label = "National Proportion"),
    inherit.aes = FALSE,
    color = "red", size = 3
  ) +
  labs(title = "Proportion of patients who received protein and energy oral nutritional supplements",
       x = "Operating Hospital", y = "Patients screened (%)") +
  theme_minimal() +
  theme(axis.text.x  = element_blank(),
        axis.ticks.x = element_blank())
})
```

```{r, echo=FALSE}
#| context: render
#| panel: fill
plotOutput("indicator3c_plot")
```

2

##

[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}

# QS 4 {#qs-4 scrolling="true"}

<h1><span style="color:#423A8E">Timing of surgery</span></h1>

A person with a hip fracture receives surgery within 36 hours of their first presentation to hospital.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

<h2><span style="color:#423A8E">Indicator 4a</span></h2>

Proportion of admitted patients with a hip fracture who received surgery within 36 hours of presentation to first hospital.

[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}

# QS 5 {#qs-5 scrolling="true"}

<h1><span style="color:#423A8E">Mobilisation and weight bearing</span></h1>

A person with a hip fracture is mobilised without restrictions on weight bearing, starting the day of, or the day after, surgery, and at least once a day thereafter, according to their clinical condition and agreed goals of care.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

## 

<h2><span style="color:#423A8E">Indicator 5a</span></h2>

Proportion of admitted patients with a hip fracture who were mobilised the day of, or the day after, their hip fracture surgery.

##

<h2><span style="color:#423A8E">Indicator 5b</span></h2>

Proportion of admitted patients with a hip fracture who experienced a new Stage-II-or-higher pressure injury.

[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}

# QS 6 {#qs-6 scrolling="true"}

<h1><span style="color:#423A8E">Minimising risk of another fracture</span></h1>

Before a person leaves hospital after a hip fracture, they receive a falls and bone health assessment and management plan, with appropriate referral for secondary fracture prevention.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

<h2><span style="color:#423A8E">Indicator 6a</span></h2>

Proportion of admitted patients with a hip fracture who received bone protection medicine while in hospital or a prescription prior to separation from hospital.


[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}

# QS 7 {#qs-7 scrolling="true"}

<h1><span style="color:#423A8E">Transition from hospital care</span></h1>

Before a person leaves hospital after a hip fracture, an individualised care plan is developed that describes their goals of care and ongoing care needs. This plan is developed in discussion with the person and their family or support people. The plan includes mobilisation activities and expected function post-injury, wound care, pain management, nutrition, fracture prevention strategies, changed or new medicines, and specific rehabilitation services and equipment. On discharge, the plan is provided to the person and communicated with their general practice and other ongoing clinicians and care providers.

Last Modified: `r format(Sys.time(), "%d %b %Y", tz="Australia/Sydney")` `r format(Sys.time(), "%H:%M:%S", tz="Australia/Sydney")`

<h2><span style="color:#423A8E">Indicator 7a</span></h2>

Evidence of local arrangements for the development of an individualised care plan for hip fracture patients prior to separation from hospital.

[⬅ Go Back to Home](#home){.btn .btn-secondary .btn-lg style="margin-top:20px; width:100%;"}
